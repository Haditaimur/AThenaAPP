import React, { useState, useEffect } from 'react';
import { Camera, ArrowLeft, Plus, CheckCircle, AlertCircle, Clock, Users } from 'lucide-react';

const HotelMaintenanceApp = () => {
  const [currentScreen, setCurrentScreen] = useState('role-select');
  const [selectedJob, setSelectedJob] = useState(null);
  const [currentRole, setCurrentRole] = useState(null);
  const [rooms, setRooms] = useState([]);
  const [jobs, setJobs] = useState([]);
  const [dataLoaded, setDataLoaded] = useState(false);
  const [formData, setFormData] = useState({
    room: '',
    title: '',
    description: '',
    status: 'To Do',
    photo: null
  });
  const [completionNote, setCompletionNote] = useState('');
  const [selectedFloor, setSelectedFloor] = useState(null);
  const [selectedRoom, setSelectedRoom] = useState(null);
  const [enlargedPhoto, setEnlargedPhoto] = useState(null);
  const [isEditingJob, setIsEditingJob] = useState(false);
  const [editFormData, setEditFormData] = useState({
    title: '',
    description: ''
  });
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [jobToDelete, setJobToDelete] = useState(null);

  // Floor definitions
  const floors = [
    { id: 'general', name: 'General / Other', label: '⚙️' },
    { id: '-1', name: 'Basement', label: 'B' },
    { id: '0', name: 'Ground Floor', label: 'G' },
    { id: '1', name: 'First Floor', label: '1' },
    { id: '2', name: 'Second Floor', label: '2' },
    { id: '3', name: 'Third Floor', label: '3' },
    { id: '4', name: 'Fourth Floor', label: '4' }
  ];

  useEffect(() => {
    if (!dataLoaded) {
      loadData();
    }
  }, [dataLoaded]);

  const loadData = async () => {
    const defaultRooms = [
      // General/Other - not tied to specific room
      { id: '0', number: 'General', floor: 'general', notes: 'Not room-specific' },
      // Basement (-1)
      { id: '1', number: '51', floor: '-1', notes: 'Triple Room' },
      { id: '2', number: '52', floor: '-1', notes: 'Triple Room' },
      { id: '3', number: '53', floor: '-1', notes: 'Twin Room' },
      { id: '4', number: '54', floor: '-1', notes: 'Triple Room' },
      // Ground Floor (0)
      { id: '5', number: '1', floor: '0', notes: 'Single Room' },
      { id: '6', number: '2', floor: '0', notes: 'Family Room' },
      { id: '7', number: '3', floor: '0', notes: 'Double Room' },
      { id: '8', number: '4', floor: '0', notes: 'Double Room' },
      { id: '9', number: '5', floor: '0', notes: 'Twin Room' },
      { id: '10', number: '6', floor: '0', notes: 'Triple Room' },
      { id: '11', number: '7', floor: '0', notes: 'Family Room' },
      { id: '12', number: '2b', floor: '0', notes: 'Twin Room' },
      { id: '13', number: '8', floor: '0', notes: 'Twin Room' },
      // First Floor (1)
      { id: '14', number: '11', floor: '1', notes: 'Triple Room' },
      { id: '15', number: '12', floor: '1', notes: 'Triple Room' },
      { id: '16', number: '12', floor: '1', notes: 'Triple Room' },
      { id: '17', number: '13', floor: '1', notes: 'Quad Room' },
      { id: '18', number: '14', floor: '1', notes: 'Family Room' },
      { id: '19', number: '15', floor: '1', notes: 'Double Room' },
      { id: '20', number: '16', floor: '1', notes: 'Double Room' },
      { id: '21', number: '9', floor: '1', notes: 'Single Room' },
      { id: '22', number: '5b', floor: '1', notes: 'Single Room' },
      // Second Floor (2)
      { id: '23', number: '21', floor: '2', notes: 'Family Room' },
      { id: '24', number: '22', floor: '2', notes: 'Family Room' },
      { id: '25', number: '23', floor: '2', notes: 'Family Room' },
      { id: '26', number: '24', floor: '2', notes: 'Family Room' },
      { id: '27', number: '25', floor: '2', notes: 'Double Room' },
      { id: '28', number: '26', floor: '2', notes: 'Double Room' },
      // Third Floor (3)
      { id: '29', number: '31', floor: '3', notes: 'Quad Room' },
      { id: '30', number: '32', floor: '3', notes: 'Quad Room' },
      { id: '31', number: '33', floor: '3', notes: 'Quad Room' },
      { id: '32', number: '34', floor: '3', notes: 'Triple Room' },
      { id: '33', number: '35', floor: '3', notes: 'Double Room' },
      { id: '34', number: '36', floor: '3', notes: 'Double Room' },
      // Fourth Floor (4)
      { id: '35', number: '41', floor: '4', notes: 'Triple Room' },
      { id: '36', number: '42', floor: '4', notes: 'Triple Room' },
      { id: '37', number: '43', floor: '4', notes: 'Triple Room' },
      { id: '38', number: '44', floor: '4', notes: 'Triple Room' },
      { id: '39', number: '45', floor: '4', notes: 'Single Room' },
      { id: '40', number: '46', floor: '4', notes: 'Single Room' }
    ];

    const defaultJobs = [
      // General/Other jobs (not room-specific)
      {
        id: '14',
        roomId: '0',
        roomNumber: 'General',
        floor: 'general',
        title: 'Exterior Sign Repair',
        description: 'Hotel entrance sign light not working',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '15',
        roomId: '0',
        roomNumber: 'General',
        floor: 'general',
        title: 'Parking Lot Pothole',
        description: 'Large pothole near entrance needs repair',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      // Basement jobs (floor: '-1')
      {
        id: '1',
        roomId: '2',
        roomNumber: '52',
        floor: '-1',
        title: 'Washing Machine Repair',
        description: 'Main washing machine making loud noise',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '2',
        roomId: '3',
        roomNumber: '53',
        floor: '-1',
        title: 'Water Heater Check',
        description: 'Annual maintenance check needed',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      // Ground Floor jobs (floor: '0')
      {
        id: '3',
        roomId: '5',
        roomNumber: '1',
        floor: '0',
        title: 'Reception Desk Light',
        description: 'Main desk light flickering',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '4',
        roomId: '10',
        roomNumber: '6',
        floor: '0',
        title: 'Kitchen Sink Leak',
        description: 'Small leak under kitchen sink',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      // First Floor jobs (floor: '1')
      {
        id: '5',
        roomId: '14',
        roomNumber: '11',
        floor: '1',
        title: 'Shower Leak',
        description: 'Water leaking from shower head connection',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '6',
        roomId: '15',
        roomNumber: '12',
        floor: '1',
        title: 'Bedside Lamp Flickering',
        description: 'Left bedside lamp flickering intermittently',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '7',
        roomId: '18',
        roomNumber: '14',
        floor: '1',
        title: 'Window Lock Broken',
        description: 'Window lock needs replacement',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      // Second Floor jobs (floor: '2')
      {
        id: '8',
        roomId: '24',
        roomNumber: '22',
        floor: '2',
        title: 'AC Not Working',
        description: 'Air conditioning unit not responding',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '9',
        roomId: '25',
        roomNumber: '23',
        floor: '2',
        title: 'Loose Bathroom Tile',
        description: 'Floor tile near sink is loose',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      // Third Floor jobs (floor: '3')
      {
        id: '10',
        roomId: '29',
        roomNumber: '31',
        floor: '3',
        title: 'Window Handle Loose',
        description: 'Window handle needs tightening',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '11',
        roomId: '30',
        roomNumber: '32',
        floor: '3',
        title: 'Curtain Rail Fixed',
        description: 'Curtain rail repaired and secured',
        status: 'Done',
        photo: null,
        completionNote: 'Replaced mounting brackets and reinforced with additional screws',
        createdAt: new Date(Date.now() - 86400000).toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '16',
        roomId: '31',
        roomNumber: '33',
        floor: '3',
        title: 'Bathroom Mirror Cracked',
        description: 'Mirror needs replacement',
        status: 'Done',
        photo: null,
        completionNote: 'Replaced with new mirror',
        createdAt: new Date(Date.now() - 172800000).toISOString(),
        updatedAt: new Date(Date.now() - 86400000).toISOString()
      },
      {
        id: '17',
        roomId: '32',
        roomNumber: '34',
        floor: '3',
        title: 'TV Remote Not Working',
        description: 'Remote control batteries dead',
        status: 'Done',
        photo: null,
        completionNote: 'Replaced batteries',
        createdAt: new Date(Date.now() - 259200000).toISOString(),
        updatedAt: new Date(Date.now() - 172800000).toISOString()
      },
      // Fourth Floor jobs (floor: '4')
      {
        id: '12',
        roomId: '35',
        roomNumber: '41',
        floor: '4',
        title: 'Balcony Door Lock',
        description: 'Balcony door lock is stuck',
        status: 'To Do',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      },
      {
        id: '13',
        roomId: '38',
        roomNumber: '44',
        floor: '4',
        title: 'Minibar Not Cooling',
        description: 'Presidential suite minibar not cooling properly',
        status: 'Urgent',
        photo: null,
        completionNote: '',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      }
    ];

    try {
      const roomsData = await window.storage.get('hotel-rooms');
      if (roomsData) {
        setRooms(JSON.parse(roomsData.value));
      } else {
        setRooms(defaultRooms);
        await window.storage.set('hotel-rooms', JSON.stringify(defaultRooms));
      }
    } catch (error) {
      setRooms(defaultRooms);
    }

    try {
      const jobsData = await window.storage.get('hotel-jobs');
      if (jobsData) {
        setJobs(JSON.parse(jobsData.value));
      } else {
        setJobs(defaultJobs);
        await window.storage.set('hotel-jobs', JSON.stringify(defaultJobs));
      }
    } catch (error) {
      setJobs(defaultJobs);
    }

    setDataLoaded(true);
  };

  const saveJobs = async (updatedJobs) => {
    setJobs(updatedJobs);
    try {
      await window.storage.set('hotel-jobs', JSON.stringify(updatedJobs));
    } catch (error) {
      console.error('Error saving jobs:', error);
    }
  };

  const updateJobStatus = async (jobId, newStatus, note = '') => {
    const updatedJobs = jobs.map(job => {
      if (job.id === jobId) {
        // Ensure floor field exists when updating
        const room = rooms.find(r => String(r.id) === String(job.roomId));
        return {
          ...job, 
          status: newStatus, 
          completionNote: note || job.completionNote || '',
          floor: job.floor || (room ? room.floor : 'unknown'),
          updatedAt: new Date().toISOString() 
        };
      }
      return job;
    });
    await saveJobs(updatedJobs);
    setSelectedJob(updatedJobs.find(j => j.id === jobId));
    setCompletionNote('');
  };

  const updateJobDetails = async (jobId, title, description) => {
    const updatedJobs = jobs.map(job => {
      if (job.id === jobId) {
        // Ensure floor field exists when updating
        const room = rooms.find(r => String(r.id) === String(job.roomId));
        return {
          ...job, 
          title: title,
          description: description,
          floor: job.floor || (room ? room.floor : 'unknown'),
          updatedAt: new Date().toISOString() 
        };
      }
      return job;
    });
    await saveJobs(updatedJobs);
    setSelectedJob(updatedJobs.find(j => j.id === jobId));
    setIsEditingJob(false);
  };

  const updateJobPhoto = async (jobId, photoData) => {
    const updatedJobs = jobs.map(job =>
      job.id === jobId
        ? { ...job, photo: photoData, updatedAt: new Date().toISOString() }
        : job
    );
    await saveJobs(updatedJobs);
    setSelectedJob(updatedJobs.find(j => j.id === jobId));
  };

  const deleteJob = async (jobId) => {
    console.log('Delete initiated for job:', jobId);
    
    const updatedJobs = jobs.filter(job => job.id !== jobId);
    console.log('Jobs before:', jobs.length, 'Jobs after:', updatedJobs.length);
    
    // Update state immediately
    setJobs(updatedJobs);
    
    // Save to storage
    try {
      await window.storage.set('hotel-jobs', JSON.stringify(updatedJobs));
      console.log('Successfully saved to storage');
    } catch (error) {
      console.error('Error saving to storage:', error);
    }
    
    // Close confirmation dialog and navigate back
    setShowDeleteConfirm(false);
    setJobToDelete(null);
    setCurrentScreen('home');
  };

  const initiateDelete = (jobId) => {
    setJobToDelete(jobId);
    setShowDeleteConfirm(true);
  };

  const cancelDelete = () => {
    setShowDeleteConfirm(false);
    setJobToDelete(null);
  };

  const addNewJob = async () => {
    const room = rooms.find(r => r.id === formData.room);
    if (!room || !formData.title) return;

    const newJob = {
      id: Date.now().toString(),
      roomId: room.id,
      roomNumber: room.number,
      floor: room.floor,  // Get floor from the room
      title: formData.title,
      description: formData.description,
      status: formData.status,
      photo: formData.photo,
      completionNote: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };

    const updatedJobs = [...jobs, newJob];
    await saveJobs(updatedJobs);
    
    setFormData({
      room: '',
      title: '',
      description: '',
      status: 'To Do',
      photo: null
    });
    setCurrentScreen('home');
  };

  const handlePhotoUpload = (e, jobId = null) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (jobId) {
          updateJobPhoto(jobId, reader.result);
        } else {
          setFormData({ ...formData, photo: reader.result });
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const getStatusBadge = (status) => {
    const styles = {
      'Urgent': 'bg-red-500 text-white',
      'To Do': 'bg-yellow-500 text-black',
      'Done': 'bg-green-500 text-white'
    };
    return styles[status] || 'bg-gray-500 text-white';
  };

  const getJobsByStatus = (status) => {
    return jobs.filter(job => job.status === status);
  };

  const groupJobsByRoom = (jobsList) => {
    const grouped = {};
    jobsList.forEach(job => {
      if (!grouped[job.roomNumber]) {
        grouped[job.roomNumber] = [];
      }
      grouped[job.roomNumber].push(job);
    });
    return grouped;
  };

  const getRoomsByFloor = (floorId) => {
    return rooms.filter(room => String(room.floor) === String(floorId));
  };

  const getJobsByRoomAndStatus = (roomId, status) => {
    if (status === 'To Do') {
      // For To Do, include both To Do and Urgent jobs
      return jobs.filter(job => 
        String(job.roomId) === String(roomId) && 
        (job.status === 'To Do' || job.status === 'Urgent')
      );
    }
    return jobs.filter(job => 
      String(job.roomId) === String(roomId) && 
      job.status === status
    );
  };

  const getJobCountByFloor = (floorId, status) => {
    console.log(`=== Counting jobs for Floor: ${floorId}, Status: ${status} ===`);
    console.log('Total jobs in system:', jobs.length);
    
    // Show all jobs with their floor values
    jobs.forEach(job => {
      console.log(`Job "${job.title}": floor="${job.floor}", status="${job.status}", roomId="${job.roomId}"`);
    });
    
    let count = 0;
    
    if (status === 'To Do') {
      // For To Do, count both To Do and Urgent jobs on this floor
      const matchingJobs = jobs.filter(job => {
        const floorMatch = String(job.floor) === String(floorId);
        const statusMatch = job.status === 'To Do' || job.status === 'Urgent';
        console.log(`Job "${job.title}": floorMatch=${floorMatch} (${job.floor} vs ${floorId}), statusMatch=${statusMatch}`);
        return floorMatch && statusMatch;
      });
      count = matchingJobs.length;
      console.log(`Found ${count} To Do/Urgent jobs for floor ${floorId}:`, matchingJobs);
    } else {
      // For other statuses (like Done), only count exact matches
      const matchingJobs = jobs.filter(job => {
        const floorMatch = String(job.floor) === String(floorId);
        const statusMatch = job.status === status;
        return floorMatch && statusMatch;
      });
      count = matchingJobs.length;
      console.log(`Found ${count} ${status} jobs for floor ${floorId}:`, matchingJobs);
    }
    
    console.log(`=== Final count for floor ${floorId}: ${count} ===`);
    return count;
  };

  const getJobCountByRoom = (roomId, status) => {
    let count = 0;
    
    if (status === 'To Do') {
      // For To Do, count both To Do and Urgent jobs in this room
      count = jobs.filter(job => 
        String(job.roomId) === String(roomId) && 
        (job.status === 'To Do' || job.status === 'Urgent')
      ).length;
    } else {
      // For other statuses (like Done), only count exact matches
      count = jobs.filter(job => 
        String(job.roomId) === String(roomId) && 
        job.status === status
      ).length;
    }
    
    return count;
  };

  const handleLogout = () => {
    setCurrentRole(null);
    setCurrentScreen('role-select');
    setSelectedFloor(null);
    setSelectedRoom(null);
  };

  const selectRole = (role) => {
    setCurrentRole(role);
    setCurrentScreen('home');
  };

  // ROLE SELECTION SCREEN
  if (currentScreen === 'role-select') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
        <div className="max-w-md w-full">
          <div className="bg-white rounded-lg shadow-2xl p-8">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-800 mb-2">Hotel Maintenance</h1>
              <p className="text-gray-600">Select Your Role</p>
            </div>

            <div className="space-y-4">
              <button
                onClick={() => selectRole('manager')}
                className="w-full bg-blue-600 text-white p-6 rounded-lg text-xl font-semibold hover:bg-blue-700 transition shadow-lg transform hover:scale-105"
              >
                <div className="flex items-center justify-center gap-3">
                  <Users size={32} />
                  <span>Manager</span>
                </div>
                <p className="text-sm text-blue-100 mt-2">Full access - add, edit, delete jobs</p>
              </button>

              <button
                onClick={() => selectRole('handyman')}
                className="w-full bg-green-600 text-white p-6 rounded-lg text-xl font-semibold hover:bg-green-700 transition shadow-lg transform hover:scale-105"
              >
                <div className="flex items-center justify-center gap-3">
                  <CheckCircle size={32} />
                  <span>Handyman</span>
                </div>
                <p className="text-sm text-green-100 mt-2">Add, view and update jobs</p>
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // HOME SCREEN
  if (currentScreen === 'home') {
    const urgentCount = getJobsByStatus('Urgent').length;
    const todoCount = getJobsByStatus('To Do').length + getJobsByStatus('Urgent').length; // Include Urgent in To Do count
    const doneCount = getJobsByStatus('Done').length;

    return (
      <div className="min-h-screen bg-gray-100 p-4">
        <div className="max-w-md mx-auto">
          <div className="bg-white rounded-lg shadow-md p-6 mb-4">
            <div className="flex justify-between items-center mb-4">
              <h1 className="text-2xl font-bold text-gray-800">Maintenance Tracker</h1>
              <button
                onClick={handleLogout}
                className="p-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition font-semibold"
              >
                Logout
              </button>
            </div>
            <p className="text-sm text-gray-600">Role: <span className="font-semibold capitalize">{currentRole}</span></p>
          </div>

          <div className="space-y-4">
            <button
              onClick={() => setCurrentScreen('urgent')}
              className="w-full bg-red-500 text-white p-8 rounded-lg shadow-lg hover:bg-red-600 transition"
            >
              <div className="flex items-center justify-between">
                <div className="text-left">
                  <AlertCircle size={32} className="mb-2" />
                  <h2 className="text-2xl font-bold">Urgent Jobs</h2>
                  <p className="text-red-100 mt-1">Immediate attention required</p>
                </div>
                <div className="text-5xl font-bold">{urgentCount}</div>
              </div>
            </button>

            <button
              onClick={() => setCurrentScreen('todo-floors')}
              className="w-full bg-yellow-500 text-black p-8 rounded-lg shadow-lg hover:bg-yellow-600 transition"
            >
              <div className="flex items-center justify-between">
                <div className="text-left">
                  <Clock size={32} className="mb-2" />
                  <h2 className="text-2xl font-bold">To Do Jobs</h2>
                  <p className="text-yellow-900 mt-1">Scheduled maintenance</p>
                </div>
                <div className="text-5xl font-bold">{todoCount}</div>
              </div>
            </button>

            <button
              onClick={() => setCurrentScreen('done-floors')}
              className="w-full bg-green-500 text-white p-8 rounded-lg shadow-lg hover:bg-green-600 transition"
            >
              <div className="flex items-center justify-between">
                <div className="text-left">
                  <CheckCircle size={32} className="mb-2" />
                  <h2 className="text-2xl font-bold">Done Jobs</h2>
                  <p className="text-green-100 mt-1">Completed tasks</p>
                </div>
                <div className="text-5xl font-bold">{doneCount}</div>
              </div>
            </button>
          </div>

          {currentRole === 'manager' && (
            <button
              onClick={() => setCurrentScreen('add')}
              className="w-full mt-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2"
            >
              <Plus size={24} />
              <span className="text-xl font-semibold">Add New Job</span>
            </button>
          )}

          {currentRole === 'handyman' && (
            <button
              onClick={() => setCurrentScreen('add')}
              className="w-full mt-4 bg-green-600 text-white p-4 rounded-lg shadow-lg hover:bg-green-700 transition flex items-center justify-center gap-2"
            >
              <Plus size={24} />
              <span className="text-xl font-semibold">Add New Job</span>
            </button>
          )}
        </div>
      </div>
    );
  }

  // FLOORS SCREEN (for To Do and Done jobs)
  if (currentScreen === 'todo-floors' || currentScreen === 'done-floors') {
    const status = currentScreen === 'todo-floors' ? 'To Do' : 'Done';
    const color = currentScreen === 'todo-floors' ? 'bg-yellow-500' : 'bg-green-500';
    const title = currentScreen === 'todo-floors' ? 'To Do Jobs - Select Floor' : 'Done Jobs - Select Floor';

    return (
      <div className="min-h-screen bg-gray-100">
        <div className={`${color} text-white p-4 shadow-md`}>
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => setCurrentScreen('home')} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-2xl font-bold">{title}</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4">
          {!dataLoaded ? (
            <div className="bg-white rounded-lg p-8 text-center text-gray-500">
              <p>Loading...</p>
            </div>
          ) : (
            <div className="space-y-3">
              {floors.map(floor => {
                const floorRooms = getRoomsByFloor(floor.id);
                const jobCount = getJobCountByFloor(floor.id, status);
                
                return (
                  <button
                    key={floor.id}
                    onClick={() => {
                      setSelectedFloor(floor.id);
                      setCurrentScreen(currentScreen === 'todo-floors' ? 'todo-rooms' : 'done-rooms');
                    }}
                    className="w-full bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition text-left"
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <div className="flex items-center gap-3">
                          <div className={`w-12 h-12 ${color} text-white rounded-full flex items-center justify-center text-xl font-bold`}>
                            {floor.label}
                          </div>
                          <div>
                            <h3 className="text-xl font-bold text-gray-800">{floor.name}</h3>
                            <p className="text-sm text-gray-600">{floorRooms.length} room{floorRooms.length !== 1 ? 's' : ''}</p>
                          </div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-bold text-gray-800">{jobCount}</div>
                        <p className="text-sm text-gray-600">job{jobCount !== 1 ? 's' : ''}</p>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </div>
      </div>
    );
  }

  // ROOMS SCREEN (for selected floor)
  if (currentScreen === 'todo-rooms' || currentScreen === 'done-rooms') {
    const status = currentScreen === 'todo-rooms' ? 'To Do' : 'Done';
    const color = currentScreen === 'todo-rooms' ? 'bg-yellow-500' : 'bg-green-500';
    const floorInfo = floors.find(f => f.id === selectedFloor);
    const floorRooms = getRoomsByFloor(selectedFloor);

    return (
      <div className="min-h-screen bg-gray-100">
        <div className={`${color} text-white p-4 shadow-md`}>
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => setCurrentScreen(currentScreen === 'todo-rooms' ? 'todo-floors' : 'done-floors')} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-2xl font-bold">{floorInfo?.name} - Rooms</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4">
          {floorRooms.length === 0 ? (
            <div className="bg-white rounded-lg p-8 text-center text-gray-500">
              <p>No rooms on this floor</p>
            </div>
          ) : (
            <div className="space-y-3">
              {floorRooms.map(room => {
                const roomJobCount = getJobCountByRoom(room.id, status);
                
                return (
                  <button
                    key={room.id}
                    onClick={() => {
                      setSelectedRoom(room.id);
                      setCurrentScreen(currentScreen === 'todo-rooms' ? 'todo-room-jobs' : 'done-room-jobs');
                    }}
                    className="w-full bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition text-left"
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <h3 className="text-2xl font-bold text-gray-800">Room {room.number}</h3>
                        <p className="text-sm text-gray-600">{room.notes}</p>
                      </div>
                      <div className="text-right">
                        <div className="text-3xl font-bold text-gray-800">{roomJobCount}</div>
                        <p className="text-sm text-gray-600">jobs</p>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          )}
        </div>
      </div>
    );
  }

  // ROOM JOBS SCREEN
  if (currentScreen === 'todo-room-jobs' || currentScreen === 'done-room-jobs') {
    const status = currentScreen === 'todo-room-jobs' ? 'To Do' : 'Done';
    const color = currentScreen === 'todo-room-jobs' ? 'bg-yellow-500' : 'bg-green-500';
    const roomInfo = rooms.find(r => r.id === selectedRoom);
    const roomJobs = getJobsByRoomAndStatus(selectedRoom, status);

    return (
      <div className="min-h-screen bg-gray-100">
        <div className={`${color} text-white p-4 shadow-md`}>
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => setCurrentScreen(currentScreen === 'todo-room-jobs' ? 'todo-rooms' : 'done-rooms')} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-2xl font-bold">Room {roomInfo?.number} - Jobs</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4">
          {roomJobs.length === 0 ? (
            <div className="bg-white rounded-lg p-8 text-center text-gray-500">
              <p>No {status.toLowerCase()} jobs in this room</p>
            </div>
          ) : (
            <div className="space-y-4">
                                {roomJobs.map(job => (
                <div
                  key={job.id}
                  onClick={() => {
                    setSelectedJob(job);
                    setCurrentScreen('detail');
                  }}
                  className="bg-white rounded-lg shadow-md p-4 hover:shadow-lg cursor-pointer transition"
                >
                  <div className="flex gap-3">
                    {job.photo && (
                      <img
                        src={job.photo}
                        alt={job.title}
                        onClick={(e) => {
                          e.stopPropagation();
                          setEnlargedPhoto(job.photo);
                        }}
                        className="w-20 h-20 object-cover rounded cursor-pointer hover:opacity-75 transition"
                      />
                    )}
                    <div className="flex-1">
                      <h3 className="font-semibold text-xl mb-2">{job.title}</h3>
                      <p className="text-gray-600 text-sm mb-2">{job.description}</p>
                      <span className={`inline-block px-3 py-1 rounded-full text-sm font-semibold ${getStatusBadge(job.status)}`}>
                        {job.status}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Photo Enlargement Modal */}
        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            <div className="relative max-w-4xl w-full">
              <button
                onClick={() => setEnlargedPhoto(null)}
                className="absolute top-4 right-4 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl hover:bg-gray-200 transition"
              >
                ×
              </button>
              <img
                src={enlargedPhoto}
                alt="Enlarged view"
                className="w-full h-auto max-h-screen object-contain rounded-lg"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
        )}
      </div>
    );
  }

  // JOBS LIST SCREEN (Urgent only - direct list)
  if (currentScreen === 'urgent') {
    const statusMap = {
      'urgent': 'Urgent'
    };
    const colorMap = {
      'urgent': 'bg-red-500'
    };
    const titleMap = {
      'urgent': 'Urgent Jobs'
    };

    const status = statusMap[currentScreen];
    const color = colorMap[currentScreen];
    const title = titleMap[currentScreen];

    const filteredJobs = getJobsByStatus(status);
    const groupedJobs = groupJobsByRoom(filteredJobs);

    return (
      <div className="min-h-screen bg-gray-100">
        <div className={`${color} text-white p-4 shadow-md`}>
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => setCurrentScreen('home')} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-2xl font-bold">{title}</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4">
          {filteredJobs.length === 0 ? (
            <div className="bg-white rounded-lg p-8 text-center text-gray-500">
              <p>No {status.toLowerCase()} jobs</p>
            </div>
          ) : (
            <div className="space-y-4">
              {Object.entries(groupedJobs).map(([roomNum, roomJobs]) => (
                <div key={roomNum} className="bg-white rounded-lg shadow-md overflow-hidden">
                  <div className="bg-gray-200 px-4 py-2 font-semibold text-gray-700">
                    Room {roomNum}
                  </div>
                  {roomJobs.map(job => (
                    <div
                      key={job.id}
                      onClick={() => {
                        setSelectedJob(job);
                        setCurrentScreen('detail');
                      }}
                      className="p-4 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 cursor-pointer"
                    >
                      <div className="flex gap-3">
                        {job.photo && (
                          <img
                            src={job.photo}
                            alt={job.title}
                            onClick={(e) => {
                              e.stopPropagation();
                              setEnlargedPhoto(job.photo);
                            }}
                            className="w-16 h-16 object-cover rounded cursor-pointer hover:opacity-75 transition"
                          />
                        )}
                        <div className="flex-1">
                          <h3 className="font-semibold text-lg">{job.title}</h3>
                          <span className={`inline-block px-3 py-1 rounded-full text-sm font-semibold mt-2 ${getStatusBadge(job.status)}`}>
                            {job.status}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Photo Enlargement Modal */}
        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            <div className="relative max-w-4xl w-full">
              <button
                onClick={() => setEnlargedPhoto(null)}
                className="absolute top-4 right-4 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl hover:bg-gray-200 transition"
              >
                ×
              </button>
              <img
                src={enlargedPhoto}
                alt="Enlarged view"
                className="w-full h-auto max-h-screen object-contain rounded-lg"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
        )}
      </div>
    );
  }

  // JOB DETAIL SCREEN
  if (currentScreen === 'detail' && selectedJob) {
    const handleMarkAsDone = () => {
      updateJobStatus(selectedJob.id, 'Done', completionNote);
    };

    const startEditingJob = () => {
      setEditFormData({
        title: selectedJob.title,
        description: selectedJob.description
      });
      setIsEditingJob(true);
    };

    const saveJobEdit = () => {
      if (editFormData.title.trim()) {
        updateJobDetails(selectedJob.id, editFormData.title, editFormData.description);
      }
    };

    const cancelJobEdit = () => {
      setIsEditingJob(false);
      setEditFormData({ title: '', description: '' });
    };

    return (
      <div className="min-h-screen bg-gray-100">
        <div className="bg-blue-600 text-white p-4 shadow-md">
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => {
              const prevScreen = selectedJob.status === 'Urgent' ? 'urgent' : 
                                 selectedJob.status === 'To Do' ? 'todo-room-jobs' : 'done-room-jobs';
              setCurrentScreen(prevScreen);
              setIsEditingJob(false);
            }} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">Job Details</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4 space-y-4">
          <div className="bg-white rounded-lg shadow-md overflow-hidden">
            {selectedJob.photo ? (
              <img
                src={selectedJob.photo}
                alt={selectedJob.title}
                onClick={() => setEnlargedPhoto(selectedJob.photo)}
                className="w-full h-64 object-cover cursor-pointer hover:opacity-90 transition"
              />
            ) : (
              <div className="w-full h-64 bg-gray-200 flex items-center justify-center">
                <Camera size={48} className="text-gray-400" />
              </div>
            )}
            
            <div className="p-4 space-y-2">
              <input
                type="file"
                accept="image/*"
                capture="environment"
                onChange={(e) => handlePhotoUpload(e, selectedJob.id)}
                className="hidden"
                id={`photo-camera-${selectedJob.id}`}
              />
              <button
                type="button"
                onClick={() => document.getElementById(`photo-camera-${selectedJob.id}`).click()}
                className="w-full bg-blue-500 text-white px-4 py-3 rounded-lg text-center cursor-pointer hover:bg-blue-600 transition font-semibold"
              >
                <Camera size={20} className="inline mr-2" />
                Take Photo
              </button>
              
              <input
                type="file"
                accept="image/*"
                onChange={(e) => handlePhotoUpload(e, selectedJob.id)}
                className="hidden"
                id={`photo-file-${selectedJob.id}`}
              />
              <button
                type="button"
                onClick={() => document.getElementById(`photo-file-${selectedJob.id}`).click()}
                className="w-full bg-green-500 text-white px-4 py-3 rounded-lg text-center cursor-pointer hover:bg-green-600 transition font-semibold"
              >
                <Plus size={20} className="inline mr-2" />
                Upload Photo
              </button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-md p-4 space-y-3">
            <div>
              <p className="text-sm text-gray-600">Room Number</p>
              <p className="text-2xl font-bold">{selectedJob.roomNumber}</p>
            </div>

            {isEditingJob ? (
              <>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Title</label>
                  <input
                    type="text"
                    value={editFormData.title}
                    onChange={(e) => setEditFormData({ ...editFormData, title: e.target.value })}
                    className="w-full p-3 border-2 border-blue-300 rounded-lg text-lg font-semibold focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                  <textarea
                    value={editFormData.description}
                    onChange={(e) => setEditFormData({ ...editFormData, description: e.target.value })}
                    className="w-full p-3 border-2 border-blue-300 rounded-lg text-lg h-32 focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div className="flex gap-2">
                  <button
                    onClick={saveJobEdit}
                    className="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition"
                  >
                    Save Changes
                  </button>
                  <button
                    onClick={cancelJobEdit}
                    className="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition"
                  >
                    Cancel
                  </button>
                </div>
              </>
            ) : (
              <>
                <div>
                  <div className="flex justify-between items-start mb-2">
                    <p className="text-sm text-gray-600">Title</p>
                    <button
                      onClick={startEditingJob}
                      className="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-blue-600 transition"
                    >
                      Edit Job
                    </button>
                  </div>
                  <p className="text-xl font-semibold">{selectedJob.title}</p>
                </div>

                <div>
                  <p className="text-sm text-gray-600">Description</p>
                  <p className="text-gray-800">{selectedJob.description}</p>
                </div>
              </>
            )}

            <div>
              <p className="text-sm text-gray-600 mb-2">Status</p>
              <select
                value={selectedJob.status}
                onChange={(e) => updateJobStatus(selectedJob.id, e.target.value)}
                disabled={isEditingJob}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg font-semibold disabled:opacity-50"
                style={{
                  backgroundColor: selectedJob.status === 'Urgent' ? '#ef4444' : selectedJob.status === 'To Do' ? '#eab308' : '#22c55e',
                  color: selectedJob.status === 'To Do' ? '#000' : '#fff'
                }}
              >
                <option value="Urgent">Urgent</option>
                <option value="To Do">To Do</option>
                <option value="Done">Done</option>
              </select>
            </div>

            {selectedJob.completionNote && (
              <div>
                <p className="text-sm text-gray-600">Completion Note</p>
                <p className="text-gray-800 bg-green-50 p-3 rounded border border-green-200">{selectedJob.completionNote}</p>
              </div>
            )}

            <div>
              <p className="text-sm text-gray-600">Created</p>
              <p className="text-gray-800">{new Date(selectedJob.createdAt).toLocaleString()}</p>
            </div>

            <div>
              <p className="text-sm text-gray-600">Last Updated</p>
              <p className="text-gray-800">{new Date(selectedJob.updatedAt).toLocaleString()}</p>
            </div>
          </div>

          {!isEditingJob && currentRole === 'handyman' && selectedJob.status !== 'Done' && (
            <div className="bg-white rounded-lg shadow-md p-4 space-y-3">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">
                  Add Completion Note (Optional)
                </label>
                <textarea
                  value={completionNote}
                  onChange={(e) => setCompletionNote(e.target.value)}
                  className="w-full p-3 border border-gray-300 rounded-lg text-lg h-24"
                  placeholder="Add details about how you fixed this issue..."
                />
              </div>
              <button
                onClick={handleMarkAsDone}
                className="w-full bg-green-500 text-white p-4 rounded-lg font-semibold text-lg hover:bg-green-600 transition"
              >
                <CheckCircle size={24} className="inline mr-2" />
                Quick Mark as Done
              </button>
            </div>
          )}

          {!isEditingJob && currentRole === 'manager' && (
            <div className="space-y-3">
              <button
                onClick={() => initiateDelete(selectedJob.id)}
                className="w-full bg-red-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-red-700 transition"
              >
                Delete Job
              </button>
            </div>
          )}
        </div>

        {/* Delete Confirmation Modal */}
        {showDeleteConfirm && (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-2xl max-w-md w-full p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Delete Job?</h2>
              <p className="text-gray-600 mb-6">
                Are you sure you want to delete this job? This action cannot be undone.
              </p>
              <div className="flex gap-3">
                <button
                  onClick={cancelDelete}
                  className="flex-1 bg-gray-300 text-gray-800 p-3 rounded-lg font-semibold hover:bg-gray-400 transition"
                >
                  Cancel
                </button>
                <button
                  onClick={() => deleteJob(jobToDelete)}
                  className="flex-1 bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition"
                >
                  Delete
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Photo Enlargement Modal */}
        {enlargedPhoto && (
          <div 
            className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4"
            onClick={() => setEnlargedPhoto(null)}
          >
            <div className="relative max-w-4xl w-full">
              <button
                onClick={() => setEnlargedPhoto(null)}
                className="absolute top-4 right-4 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl hover:bg-gray-200 transition"
              >
                ×
              </button>
              <img
                src={enlargedPhoto}
                alt="Enlarged view"
                className="w-full h-auto max-h-screen object-contain rounded-lg"
                onClick={(e) => e.stopPropagation()}
              />
            </div>
          </div>
        )}
      </div>
    );
  }

  // ADD JOB FORM
  if (currentScreen === 'add') {
    return (
      <div className="min-h-screen bg-gray-100">
        <div className="bg-blue-600 text-white p-4 shadow-md">
          <div className="max-w-md mx-auto flex items-center gap-4">
            <button onClick={() => setCurrentScreen('home')} className="p-2">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-2xl font-bold">Add New Job</h1>
          </div>
        </div>

        <div className="max-w-md mx-auto p-4">
          <div className="bg-white rounded-lg shadow-md p-6 space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Room</label>
              <select
                value={formData.room}
                onChange={(e) => setFormData({ ...formData, room: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg"
              >
                <option value="">Select Room</option>
                <option value="0" className="font-bold bg-yellow-50">⚙️ General / Other (Not room-specific)</option>
                <option disabled>─────────────────────</option>
                {rooms.filter(room => room.id !== '0').map(room => (
                  <option key={room.id} value={room.id}>
                    Room {room.number} - {room.notes}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Title</label>
              <input
                type="text"
                value={formData.title}
                onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg"
                placeholder="Brief description"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Description</label>
              <textarea
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg h-32"
                placeholder="Detailed description"
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Status</label>
              <select
                value={formData.status}
                onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                className="w-full p-3 border border-gray-300 rounded-lg text-lg"
              >
                <option value="To Do">To Do</option>
                <option value="Urgent">Urgent</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">Photo (Optional)</label>
              <div className="space-y-2">
                <input
                  type="file"
                  accept="image/*"
                  capture="environment"
                  onChange={handlePhotoUpload}
                  className="hidden"
                  id="add-photo-camera"
                />
                <button
                  type="button"
                  onClick={() => document.getElementById('add-photo-camera').click()}
                  className="w-full p-3 border-2 border-blue-300 bg-blue-50 text-blue-700 rounded-lg text-center cursor-pointer hover:bg-blue-100 transition font-semibold"
                >
                  <Camera size={20} className="inline mr-2" />
                  Take Photo
                </button>
                
                <input
                  type="file"
                  accept="image/*"
                  onChange={handlePhotoUpload}
                  className="hidden"
                  id="add-photo-file"
                />
                <button
                  type="button"
                  onClick={() => document.getElementById('add-photo-file').click()}
                  className="w-full p-3 border-2 border-green-300 bg-green-50 text-green-700 rounded-lg text-center cursor-pointer hover:bg-green-100 transition font-semibold"
                >
                  <Plus size={20} className="inline mr-2" />
                  Upload from Gallery
                </button>
              </div>
              {formData.photo && (
                <img src={formData.photo} alt="Preview" className="mt-2 w-full h-48 object-cover rounded" />
              )}
            </div>

            <button
              onClick={addNewJob}
              disabled={!formData.room || !formData.title}
              className="w-full bg-blue-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
              Create Job
            </button>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

export default HotelMaintenanceApp;
